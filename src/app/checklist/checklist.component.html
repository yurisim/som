<div class="fixed bottom-0 left-0 right-0 z-10 bg-white dark:bg-gray-800 shadow-md p-2 w-full box-border">
  <div class="container mx-auto">
    <!-- Progress info - stacks on mobile, side-by-side on larger screens -->
    <div class="flex flex-col sm:flex-row items-center justify-between">
      <div class="flex items-center w-full sm:max-w-md mb-2 sm:mb-0">
        <mat-progress-bar
          class="w-full"
          color="primary"
          mode="determinate"
          [value]="completionPercentage"
        >
        </mat-progress-bar>
      </div>
      <div class="flex justify-between w-full sm:w-auto sm:ml-4">
        <span class="font-medium">{{ completionPercentage }}% Complete</span>
        <span class="ml-4">{{ completedItems }} / {{ totalItems }} items</span>
      </div>
    </div>
  </div>
</div>

<div class="container mx-auto p-4 max-w-full box-border pb-20">
  <mat-card class="mb-4" color="primary">
    <mat-card-header>
      <mat-card-title>Rules of Engagement (RoE)</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p class="">
        This checklist is a supplemental tool and does not replace the official
        Dormitory Standard Operating Procedure (SOP). Users must follow the
        actual Dorm SOP for complete guidance. Efforts will be made to keep this
        checklist up to date, but it is not a substitute for the official SOP.
        The official SOP will be released to you via Teams.
      </p>
      <p class="">
        Your progress is saved on your local device and only you will be able to
        view it.
      </p>
      <p class="mt-2"><strong>Current as of (CAO): 15 AUG 2025</strong></p>
    </mat-card-content>
  </mat-card>
  <mat-form-field class="w-full mb-4" appearance="outline">
    <mat-label>Search</mat-label>
    <input
      matInput
      type="text"
      [(ngModel)]="searchQuery"
      (ngModelChange)="applyFilter()"
      placeholder="e.g. Bed"
    />
    <button
      *ngIf="searchQuery"
      matSuffix
      mat-icon-button
      aria-label="Clear"
      (click)="clearSearch()"
    >
      <mat-icon>close</mat-icon>
    </button>
  </mat-form-field>
  <div class="flex flex-wrap justify-end mb-4">
    <button
      mat-icon-button
      color="primary"
      (click)="clearAll()"
      aria-label="Clear all items"
      matTooltip="Clear all items"
    >
      <mat-icon>remove_done</mat-icon>
    </button>
  </div>
  <div
    *ngIf="(filteredGroupedChecklist | keyvalue).length === 0"
    class="text-center text-gray-500 my-8"
  >
    No items match your search.
  </div>
  <mat-accordion multi togglePosition="before">
    <mat-expansion-panel
      *ngFor="
        let region of filteredGroupedChecklist | keyvalue;
        trackBy: trackByRegionKey
      "
      class="mb-2"
      [expanded]="!isRegionComplete(region.key)"
    >
      <mat-expansion-panel-header>
        <mat-panel-title class="font-medium mat-subheader">
          {{ region.key }}
        </mat-panel-title>
        <mat-panel-description class="flex-grow justify-end">
          <div class="flex items-center">
            <span
              class="mr-2"
              [ngClass]="{ 'text-green-500': isRegionComplete(region.key) }"
              >({{ getCompletedItemsInRegion(region.key) }} /
              {{ getTotalItemsInRegion(region.key) }})</span
            >
            <div
              (click)="$event.stopPropagation()"
              (keydown.enter)="$event.stopPropagation()"
              tabindex="0"
              role="button"
              class="focus:outline-none"
            >
              <button
                *ngIf="
                  getCompletedItemsInRegion(region.key) <
                  getTotalItemsInRegion(region.key)
                "
                mat-icon-button
                (click)="checkAllInRegion(region.key, true)"
                aria-label="Check all items in this region"
                matTooltip="Check all items in this region"
              >
                <mat-icon>checklist</mat-icon>
              </button>
              <button
                *ngIf="getCompletedItemsInRegion(region.key) > 0"
                mat-icon-button
                color="primary"
                (click)="clearAllInRegion(region.key)"
                aria-label="Clear all items in this region"
                matTooltip="Clear all items in this region"
              >
                <mat-icon>remove_done</mat-icon>
              </button>
            </div>
          </div>
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div *ngFor="let section of region.value | keyvalue" class="mb-4">
        <div class="flex justify-between items-center">
          <h3 class="mat-subheader font-medium break-words">
            {{ section.key }}
          </h3>
          <div *ngIf="section.value.length > 1" class="flex items-center">
            <button
              *ngIf="
                getCompletedItemsInSection(region.key, section.key) <
                getTotalItemsInSection(region.key, section.key)
              "
              mat-icon-button
              (click)="checkAllInSection(region.key, section.key, true)"
              aria-label="Check all items in this section"
              matTooltip="Check all items in this section"
            >
              <mat-icon>checklist</mat-icon>
            </button>
            <button
              *ngIf="getCompletedItemsInSection(region.key, section.key) > 0"
              mat-icon-button
              color="primary"
              (click)="clearAllInSection(region.key, section.key)"
              aria-label="Clear all items in this section"
              matTooltip="Clear all items in this section"
            >
              <mat-icon>remove_done</mat-icon>
            </button>
          </div>
        </div>
        <div *ngFor="let item of section.value" class="mb-1">
          <div class="flex items-center">
            <mat-checkbox
              [(ngModel)]="item.checked"
              (ngModelChange)="onCheckboxChange($event, item.id)"
            ></mat-checkbox>
            <div
              class="ml-2 whitespace-normal break-words cursor-pointer text-sm"
              (click)="
                item.checked = !item.checked;
                onCheckboxChange(item.checked, item.id)
              "
              (keydown.enter)="
                item.checked = !item.checked;
                onCheckboxChange(item.checked, item.id)
              "
              (keydown.space)="
                item.checked = !item.checked;
                onCheckboxChange(item.checked, item.id)
              "
              tabindex="0"
              role="checkbox"
              [attr.aria-checked]="item.checked"
            >
              {{ item.description }}
              <span class="text-gray-500 ml-1"> ({{ item.bullet }}) </span>
            </div>
          </div>
        </div>
      </div>
    </mat-expansion-panel>
  </mat-accordion>
</div>

<!-- Scroll to top FAB -->
<button
  mat-fab
  color="primary"
  class="scroll-to-top"
  (click)="scrollToTop()"
  aria-label="Scroll to top"
>
  <mat-icon>arrow_upward</mat-icon>
</button>
